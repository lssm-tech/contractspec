import type { DocBlock } from '@lssm/lib.contracts/docs';
import { registerDocBlocks } from '../../registry';

export const tech_contracts_openbanking_DocBlocks: DocBlock[] = [
  {
    id: 'docs.tech.contracts.openbanking',
    title: 'Open Banking (Powens) Overview',
    summary:
      'The Pocket Family Office vertical now supports read-only open banking capabilities powered by Powens. This doc summarises the contract surfaces, canonical data models, workflows, telemetry, and guardrails introduced to make Powens a first-class integration.',
    kind: 'reference',
    visibility: 'public',
    route: '/docs/tech/contracts/openbanking',
    tags: ['tech', 'contracts', 'openbanking'],
    body: '# Open Banking (Powens) Overview\n\nThe Pocket Family Office vertical now supports read-only open banking capabilities powered by Powens. This doc summarises the contract surfaces, canonical data models, workflows, telemetry, and guardrails introduced to make Powens a first-class integration.\n\n## Integration Spec\n\nPowens is registered under `openbanking.powens` with category `open-banking` and currently supports the BYOK ownership mode. The spec exposes three read-only capabilities:\n\n- `openbanking.accounts.read`\n- `openbanking.transactions.read`\n- `openbanking.balances.read`\n\nConfiguration and secrets are separated:\n\n| Config Field | Description |\n| --- | --- |\n| `environment` | Powens environment (`sandbox` \\| `production`) |\n| `baseUrl?` | Optional API base URL override |\n| `region?` | Optional Powens region identifier |\n| `pollingIntervalMs?` | Optional custom sync cadence |\n\n| Secret Field | Description |\n| --- | --- |\n| `clientId` | Powens OAuth client identifier |\n| `clientSecret` | Powens OAuth client secret |\n| `apiKey?` | Optional supplemental Powens API key |\n| `webhookSecret?` | Optional webhook signing secret |\n\n## Canonical Data Models\n\nCanonical schemas live in `@lssm/lib.contracts/integrations/openbanking/models`:\n\n- `BankAccountRecord` \u2013 account metadata (institution, IBAN/BIC, masked numbers, balances, sync timestamps)\n- `BankTransactionRecord` \u2013 transaction ledger (amounts, categories, counterparty, status)\n- `AccountBalanceRecord` \u2013 balance snapshots per account and balance type\n\nThese schemas power the vertical contracts and workflows, ensuring downstream features never use raw Powens payloads directly.\n\n## Provider Implementation\n\n`PowensOpenBankingProvider` wraps `PowensClient` which handles OAuth token management, request retries, and error mapping. The provider maps Powens payloads to the canonical interfaces exported from `integrations/providers/openbanking`.\n\nFactory support lives in `IntegrationProviderFactory.createOpenBankingProvider`, which validates configuration, loads BYOK secrets, and instantiates the provider.\n\n## Contracts\n\nCommand/query contracts exist under `integrations/openbanking/contracts`:\n\n- `openbanking.accounts.sync` & `openbanking.accounts.list`\n- `openbanking.transactions.sync` & `openbanking.transactions.list`\n- `openbanking.balances.refresh` & `openbanking.balances.get`\n\nThe Pocket Family Office bundle also exposes `pfo.openbanking.generate-overview`, which aggregates balances and transactions into a derived knowledge document.\n\n## Workflows\n\nNew workflow specs (all requiring the `primaryOpenBanking` slot) orchestrate the sync flows:\n\n- `pfo.workflow.sync-openbanking-accounts`\n- `pfo.workflow.sync-openbanking-transactions`\n- `pfo.workflow.refresh-openbanking-balances`\n- `pfo.workflow.generate-openbanking-overview`\n\nEach workflow runs against the Powens provider, persists canonical records, and emits telemetry.\n\n## Knowledge & LLM Exposure\n\nRaw Powens payloads are never stored in knowledge spaces. Instead, `knowledge.financial-overview` captures derived summaries (cashflow, category breakdowns, balance trends) produced by `pfo.openbanking.generate-overview`. The space is `operational` category with 180-day retention and automation write access.\n\nWhen exposing data to LLMs or analytics:\n\n- Use derived summaries only.\n- Redact PII fields using `redactOpenBankingTelemetryPayload`.\n- Never emit IBANs, unmasked account numbers, or counterparty detail in telemetry/logs.\n\n## Telemetry\n\nTelemetry constants live in `integrations/openbanking/telemetry`. Key events:\n\n- `openbanking.accounts.synced`\n- `openbanking.transactions.synced`\n- `openbanking.balances.refreshed`\n- `openbanking.overview.generated`\n\nAll events require tenant/app/blueprint/config metadata, and sensitive properties are flagged to avoid accidental leakage.\n\n## Guardrails\n\n`ensurePrimaryOpenBankingIntegration` verifies `primaryOpenBanking` is bound and healthy before workflows proceed. Runtime pre-flight checks already block workflows when the connection is disconnected or in error status.\n\n## Blueprint & Tenant Defaults\n\n`pocketFamilyOfficeBlueprint` now includes:\n\n- `primaryOpenBanking` slot (required, BYOK)\n- `openbanking.*.read` capabilities enabled by default\n- Workflow bindings for the new sync flows\n\nSample tenant bindings (`tenant.sample.ts`) reference `conn-powens-primary` and bind the new knowledge space.\n\n---\n\nFollow this doc when extending open banking support (e.g., adding payment initiation, additional providers, or expanded analytics) to keep the integration consistent and audited.\n\n\n\n\n\n',
  },
];
registerDocBlocks(tech_contracts_openbanking_DocBlocks);
