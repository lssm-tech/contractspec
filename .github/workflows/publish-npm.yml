name: Publish Libraries to npm

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run publish script without pushing to npm"
        type: boolean
        default: false
  push:
    tags:
      - "contractspec-v*"

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      BUN_VERSION: 1.3.0
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build libraries
        run: bun run build:not-apps

      - name: Publish packages
        if: ${{ inputs.dry_run != true }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          node <<'NODE'
          const { execSync } = require('node:child_process');
          const fs = require('node:fs');
          const path = require('node:path');

          const repoRoot = process.cwd();
          const packages = [
            { name: '@lssm/lib.utils-typescript', dir: 'packages/libs/utils-typescript' },
            { name: '@lssm/lib.logger', dir: 'packages/libs/logger' },
            { name: '@lssm/lib.schema', dir: 'packages/libs/schema' },
            { name: '@lssm/lib.contracts', dir: 'packages/libs/contracts' },
            { name: '@lssm/lib.graphql-core', dir: 'packages/libs/graphql-core' },
            { name: '@lssm/lib.graphql-prisma', dir: 'packages/libs/graphql-prisma' },
            { name: '@lssm/lib.graphql-federation', dir: 'packages/libs/graphql-federation' },
            { name: '@lssm/lib.error', dir: 'packages/libs/error' },
            { name: '@lssm/lib.exporter', dir: 'packages/libs/exporter' },
            { name: '@lssm/lib.ui-kit', dir: 'packages/libs/ui-kit' },
            { name: '@lssm/lib.ui-kit-web', dir: 'packages/libs/ui-kit-web' },
            { name: '@lssm/lib.design-system', dir: 'packages/libs/design-system' },
            { name: '@lssm/lib.accessibility', dir: 'packages/libs/accessibility' },
            { name: '@lssm/lib.presentation-runtime-core', dir: 'packages/libs/presentation-runtime-core' },
            { name: '@lssm/lib.presentation-runtime-react', dir: 'packages/libs/presentation-runtime-react' },
            { name: '@lssm/lib.presentation-runtime-react-native', dir: 'packages/libs/presentation-runtime-react-native' },
            { name: '@lssm/lib.bus', dir: 'packages/libs/bus' },
            { name: '@lssm/lib.database', dir: 'packages/libs/database' },
            { name: '@lssm/lib.databases', dir: 'packages/libs/databases' },
          ];

          const publishPackage = (pkg) => {
            const pkgDir = path.join(repoRoot, pkg.dir);
            const pkgJsonPath = path.join(pkgDir, 'package.json');
            const pkgJson = JSON.parse(fs.readFileSync(pkgJsonPath, 'utf8'));
            const version = pkgJson.version;

            let publishedVersions = [];
            try {
              const raw = execSync(`npm view ${pkg.name} versions --json`, { stdio: ['ignore', 'pipe', 'pipe'] }).toString().trim();
              if (raw) {
                publishedVersions = JSON.parse(raw);
              }
            } catch (error) {
              console.log(`No published versions found for ${pkg.name} (publishing first release).`);
            }

            const alreadyPublished = Array.isArray(publishedVersions)
              ? publishedVersions.includes(version)
              : publishedVersions === version;

            if (alreadyPublished) {
              console.log(`Skipping ${pkg.name}@${version} (already published).`);
              return;
            }

            console.log(`Publishing ${pkg.name}@${version}...`);
            execSync('npm publish --access public --ignore-scripts', {
              cwd: pkgDir,
              stdio: 'inherit',
            });
          };

          for (const pkg of packages) {
            publishPackage(pkg);
          }
          NODE

      - name: Publish packages (dry run)
        if: ${{ inputs.dry_run }}
        run: |
          echo "Dry run enabled; publishing skipped."
