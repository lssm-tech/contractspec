name: Publish Libraries to npm

on:
  push:
    branches:
      - release

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write
  pull-requests: write
  id-token: write # Required for OIDC
  actions: read # required so it can call workflow-jobs API
  statuses: write # required so it can set the commit status

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    environment: Production
    permissions:
      contents: write
      pull-requests: write
      issues: read
      packages: write
    env:
      BUN_VERSION: 1.3.8
      # Increase memory for large builds
      NODE_OPTIONS: --max-old-space-size=6144
      TURBO_TELEMETRY_DISABLED: 1
      DO_NOT_TRACK: 1
      OVSX_PAT: ${{ secrets.OVSX_PAT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Build libraries
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
        run: bun run build:not-apps

      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          # The command to update versions, changelogs, and changeset files
          version: bun run release:version
          # The command to publish packages
          publish: bun run release:publish
          commit: 'chore: update versions'
          title: 'chore: update versions'
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}
          CONTRACTSPEC_USE_PUBLISH_EXPORTS: 'true'

      - name: Determine non-npm publish targets
        if: steps.changesets.outputs.hasChangesets == 'false'
        id: non-npm-targets
        run: |
          BASE_SHA="${{ github.event.before }}"
          if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ] || ! git cat-file -e "${BASE_SHA}^{commit}" 2>/dev/null; then
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              BASE_SHA=$(git rev-parse HEAD^)
            else
              BASE_SHA=$(git rev-parse HEAD)
            fi
          fi

          NEXT_VSCODE_VERSION=$(jq -r .version packages/apps/vscode-contractspec/package.json)
          NEXT_ACTION_VERSION=$(jq -r .version packages/apps/action-validation/package.json)

          BASE_VSCODE_VERSION=$(git show "${BASE_SHA}:packages/apps/vscode-contractspec/package.json" 2>/dev/null | jq -r .version 2>/dev/null || true)
          BASE_ACTION_VERSION=$(git show "${BASE_SHA}:packages/apps/action-validation/package.json" 2>/dev/null | jq -r .version 2>/dev/null || true)

          if [ -n "$BASE_VSCODE_VERSION" ] && [ "$BASE_VSCODE_VERSION" != "$NEXT_VSCODE_VERSION" ]; then
            echo "publish_vscode=true" >> "$GITHUB_OUTPUT"
            echo "[publish] VS Code extension version bump detected: ${BASE_VSCODE_VERSION} -> ${NEXT_VSCODE_VERSION}"
          else
            echo "publish_vscode=false" >> "$GITHUB_OUTPUT"
            echo "[publish] Skip VS Code extension publish: no version bump in push range"
          fi

          if [ -n "$BASE_ACTION_VERSION" ] && [ "$BASE_ACTION_VERSION" != "$NEXT_ACTION_VERSION" ]; then
            echo "publish_action=true" >> "$GITHUB_OUTPUT"
            echo "[publish] GitHub Action version bump detected: ${BASE_ACTION_VERSION} -> ${NEXT_ACTION_VERSION}"
          else
            echo "publish_action=false" >> "$GITHUB_OUTPUT"
            echo "[publish] Skip GitHub Action publish: no version bump in push range"
          fi

      - name: Package VS Code extension
        if: steps.changesets.outputs.hasChangesets == 'false' && steps.non-npm-targets.outputs.publish_vscode == 'true'
        id: vscode-package
        working-directory: packages/apps/vscode-contractspec
        run: |
          bunx @vscode/vsce@3.7.1 package --no-dependencies
          VSIX_NAME=$(ls *.vsix | head -1)
          echo "vsix-name=$VSIX_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Packaged: $VSIX_NAME"

      - name: Get VS Code extension version
        if: steps.changesets.outputs.hasChangesets == 'false' && steps.non-npm-targets.outputs.publish_vscode == 'true'
        id: vscode-version
        run: |
          VERSION=$(jq -r .version packages/apps/vscode-contractspec/package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Publish VS Code extension to Marketplace
        if: steps.changesets.outputs.hasChangesets == 'false' && steps.non-npm-targets.outputs.publish_vscode == 'true'
        working-directory: packages/apps/vscode-contractspec
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          VSIX_FILE=$(ls *.vsix | head -1)
          echo "ðŸš€ Publishing $VSIX_FILE to VS Code Marketplace..."
          bunx @vscode/vsce@3.7.1 publish --packagePath "$VSIX_FILE" --pat "$VSCE_PAT"

      - name: Publish VS Code extension to Open VSX Registry
        if: steps.changesets.outputs.hasChangesets == 'false' && steps.non-npm-targets.outputs.publish_vscode == 'true' && env.OVSX_PAT != ''
        working-directory: packages/apps/vscode-contractspec
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
        run: |
          bun add -g ovsx
          VSIX_FILE=$(ls *.vsix | head -1)
          echo "ðŸš€ Publishing $VSIX_FILE to Open VSX Registry..."
          ovsx publish "$VSIX_FILE" --pat "$OVSX_PAT"
        continue-on-error: true

      - name: Upload VSIX artifact
        if: steps.changesets.outputs.hasChangesets == 'false' && steps.non-npm-targets.outputs.publish_vscode == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: vscode-extension
          path: packages/apps/vscode-contractspec/*.vsix
          retention-days: 90

      - name: Create VS Code Extension GitHub Release
        if: steps.changesets.outputs.hasChangesets == 'false' && steps.non-npm-targets.outputs.publish_vscode == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: vscode-v${{ steps.vscode-version.outputs.version }}
          name: VS Code Extension v${{ steps.vscode-version.outputs.version }}
          body: |
            ## ContractSpec VS Code Extension v${{ steps.vscode-version.outputs.version }}

            ### Installation

            - **VS Code Marketplace**: Search for "ContractSpec" in VS Code Extensions
            - **Manual**: Download the `.vsix` file below and install via `code --install-extension contractspec-${{ steps.vscode-version.outputs.version }}.vsix`

            ### What's Changed

            See [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/packages/apps/vscode-contractspec/CHANGELOG.md) for details.
          files: packages/apps/vscode-contractspec/*.vsix
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # GitHub Action Publishing
      - name: Get GitHub Action version
        if: steps.changesets.outputs.hasChangesets == 'false' && steps.non-npm-targets.outputs.publish_action == 'true'
        id: action-version
        run: |
          VERSION=$(jq -r .version packages/apps/action-validation/package.json)
          MAJOR=$(echo $VERSION | cut -d'.' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "major=$MAJOR" >> $GITHUB_OUTPUT

      - name: Create GitHub Action Release
        if: steps.changesets.outputs.hasChangesets == 'false' && steps.non-npm-targets.outputs.publish_action == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: action-v${{ steps.action-version.outputs.version }}
          name: ContractSpec Action v${{ steps.action-version.outputs.version }}
          body: |
            ## ContractSpec GitHub Action v${{ steps.action-version.outputs.version }}

            ### Usage

            ```yaml
            - uses: lssm-tech/contractspec@action-v${{ steps.action-version.outputs.version }}
              with:
                mode: validate  # or 'impact' for breaking change detection
            ```

            ### What's Changed

            See [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/packages/apps/action-validation/CHANGELOG.md) for details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update major version tag for action
        if: steps.changesets.outputs.hasChangesets == 'false' && steps.non-npm-targets.outputs.publish_action == 'true'
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com
          git tag -fa action-v${{ steps.action-version.outputs.major }} -m "Update action-v${{ steps.action-version.outputs.major }} to ${{ steps.action-version.outputs.version }}"
          git push origin action-v${{ steps.action-version.outputs.major }} --force
