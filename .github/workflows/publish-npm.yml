name: Publish Libraries to npm

on:
  push:
    branches:
      - release

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write
  pull-requests: write
  id-token: write # Required for OIDC

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
      packages: write
    env:
      BUN_VERSION: 1.3.5
      # Increase memory for large builds
      NODE_OPTIONS: --max-old-space-size=6144
      TURBO_TELEMETRY_DISABLED: 1
      DO_NOT_TRACK: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Build libraries
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
        run: bun run build:not-apps

      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          # The command to update versions, changelogs, and changeset files
          version: bun run release:version
          # The command to publish packages
          publish: bun run release:publish
          commit: "chore: update versions"
          title: "chore: update versions"
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Package VS Code extension
        if: steps.changesets.outputs.hasChangesets == 'false'
        id: vscode-package
        working-directory: packages/apps/vscode-contractspec
        run: |
          bun run package
          VSIX_NAME=$(ls *.vsix | head -1)
          echo "vsix-name=$VSIX_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Packaged: $VSIX_NAME"

      - name: Get VS Code extension version
        if: steps.changesets.outputs.hasChangesets == 'false'
        id: vscode-version
        run: |
          VERSION=$(jq -r .version packages/apps/vscode-contractspec/package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install vsce
        if: steps.changesets.outputs.hasChangesets == 'false'
        run: bun add -g @vscode/vsce

      - name: Publish VS Code extension to Marketplace
        if: steps.changesets.outputs.hasChangesets == 'false'
        working-directory: packages/apps/vscode-contractspec
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          VSIX_FILE=$(ls *.vsix | head -1)
          echo "ðŸš€ Publishing $VSIX_FILE to VS Code Marketplace..."
          vsce publish --packagePath "$VSIX_FILE" --pat "$VSCE_PAT"

      - name: Publish VS Code extension to Open VSX Registry
        if: steps.changesets.outputs.hasChangesets == 'false' && env.OVSX_PAT != ''
        working-directory: packages/apps/vscode-contractspec
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
        run: |
          bun add -g ovsx
          VSIX_FILE=$(ls *.vsix | head -1)
          echo "ðŸš€ Publishing $VSIX_FILE to Open VSX Registry..."
          ovsx publish "$VSIX_FILE" --pat "$OVSX_PAT"
        continue-on-error: true

      - name: Upload VSIX artifact
        if: steps.changesets.outputs.hasChangesets == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: vscode-extension
          path: packages/apps/vscode-contractspec/*.vsix
          retention-days: 90

      - name: Create VS Code Extension GitHub Release
        if: steps.changesets.outputs.hasChangesets == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: vscode-v${{ steps.vscode-version.outputs.version }}
          name: VS Code Extension v${{ steps.vscode-version.outputs.version }}
          body: |
            ## ContractSpec VS Code Extension v${{ steps.vscode-version.outputs.version }}

            ### Installation

            - **VS Code Marketplace**: Search for "ContractSpec" in VS Code Extensions
            - **Manual**: Download the `.vsix` file below and install via `code --install-extension contractspec-${{ steps.vscode-version.outputs.version }}.vsix`

            ### What's Changed

            See [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/packages/apps/vscode-contractspec/CHANGELOG.md) for details.
          files: packages/apps/vscode-contractspec/*.vsix
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # GitHub Action Publishing
      - name: Get GitHub Action version
        if: steps.changesets.outputs.hasChangesets == 'false'
        id: action-version
        run: |
          VERSION=$(jq -r .version packages/apps/action-validation/package.json)
          MAJOR=$(echo $VERSION | cut -d'.' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "major=$MAJOR" >> $GITHUB_OUTPUT

      - name: Create GitHub Action Release
        if: steps.changesets.outputs.hasChangesets == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: action-v${{ steps.action-version.outputs.version }}
          name: ContractSpec Action v${{ steps.action-version.outputs.version }}
          body: |
            ## ContractSpec GitHub Action v${{ steps.action-version.outputs.version }}

            ### Usage

            ```yaml
            - uses: lssm-tech/contractspec@action-v${{ steps.action-version.outputs.version }}
              with:
                mode: validate  # or 'impact' for breaking change detection
            ```

            ### What's Changed

            See [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/packages/apps/action-validation/CHANGELOG.md) for details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update major version tag for action
        if: steps.changesets.outputs.hasChangesets == 'false'
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com
          git tag -fa action-v${{ steps.action-version.outputs.major }} -m "Update action-v${{ steps.action-version.outputs.major }} to ${{ steps.action-version.outputs.version }}"
          git push origin action-v${{ steps.action-version.outputs.major }} --force
