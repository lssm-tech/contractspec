name: VS Code Extension

on:
    push:
        branches:
            - main
        paths:
            - "packages/apps/vscode-contractspec/**"
            - "packages/bundles/contractspec-workspace/**"
            - "packages/modules/contractspec-workspace/**"
            - "packages/libs/contracts/**"
            - ".github/workflows/vscode-extension.yml"
    pull_request:
        paths:
            - "packages/apps/vscode-contractspec/**"
            - "packages/bundles/contractspec-workspace/**"
            - "packages/modules/contractspec-workspace/**"
            - "packages/libs/contracts/**"
            - ".github/workflows/vscode-extension.yml"
    workflow_dispatch:
        inputs:
            publish:
                description: "Publish to VS Code Marketplace"
                required: false
                default: "false"
                type: choice
                options:
                    - "false"
                    - "true"

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    BUN_VERSION: 1.3.4
    NODE_OPTIONS: --max-old-space-size=4096
    TURBO_TELEMETRY_DISABLED: 1
    DO_NOT_TRACK: 1

jobs:
    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest
        timeout-minutes: 15
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: Cache dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.bun/install/cache
                      node_modules
                  key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Security audit
              run: bun audit

            - name: Run CodeQL Analysis
              uses: github/codeql-action/init@v3
              with:
                  languages: javascript-typescript

            - name: Autobuild
              uses: github/codeql-action/autobuild@v3

            - name: Perform CodeQL Analysis
              uses: github/codeql-action/analyze@v3
              continue-on-error: true

    build:
        name: Build & Package
        runs-on: ubuntu-latest
        timeout-minutes: 30
        needs: security-scan
        outputs:
            vsix-name: ${{ steps.package.outputs.vsix-name }}
            vsix-path: ${{ steps.package.outputs.vsix-path }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: Cache dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.bun/install/cache
                      node_modules
                  key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Cache build outputs
              uses: actions/cache@v4
              with:
                  path: |
                      packages/*/dist
                      packages/*/.next
                      packages/*/.turbo
                      packages/apps/vscode-contractspec/out
                  key: ${{ runner.os }}-build-${{ github.sha }}
                  restore-keys: |
                      ${{ runner.os }}-build-

            - name: Build workspace dependencies
              env:
                  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
                  TURBO_TEAM: ${{ vars.TURBO_TEAM }}
              run: |
                  bun run build --filter=@lssm/lib.contracts
                  bun run build --filter=@lssm/module.contractspec-workspace
                  bun run build --filter=@lssm/bundle.contractspec-workspace

            - name: Build extension
              working-directory: packages/apps/vscode-contractspec
              run: bun run build

            - name: Lint extension
              working-directory: packages/apps/vscode-contractspec
              run: bun run lint:check

            - name: Test extension
              working-directory: packages/apps/vscode-contractspec
              run: bun test
              continue-on-error: true

            - name: Package extension
              id: package
              working-directory: packages/apps/vscode-contractspec
              run: |
                  bun run package
                  VSIX_NAME=$(ls *.vsix | head -1)
                  VSIX_PATH="$(pwd)/$VSIX_NAME"
                  echo "vsix-name=$VSIX_NAME" >> $GITHUB_OUTPUT
                  echo "vsix-path=$VSIX_PATH" >> $GITHUB_OUTPUT
                  echo "ðŸ“¦ Packaged: $VSIX_NAME"
                  echo "ðŸ“¦ Path: $VSIX_PATH"

            - name: Validate VSIX package
              working-directory: packages/apps/vscode-contractspec
              run: |
                  VSIX_FILE=$(ls *.vsix | head -1)
                  echo "Validating $VSIX_FILE..."
                  bun add -g @vscode/vsce
                  vsce show "$VSIX_FILE" || echo "VSIX validation completed"

            - name: Upload VSIX artifact
              uses: actions/upload-artifact@v4
              with:
                  name: vscode-extension-${{ github.sha }}
                  path: packages/apps/vscode-contractspec/*.vsix
                  retention-days: 30

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: vscode-build-logs
                  path: |
                      packages/apps/vscode-contractspec/out/
                      packages/apps/vscode-contractspec/package.json
                  retention-days: 7

    publish:
        name: Publish to Marketplace
        needs: build
        runs-on: ubuntu-latest
        timeout-minutes: 20
        if: |
            (github.event_name == 'workflow_dispatch' && github.event.inputs.publish == 'true') ||
            (github.event_name == 'push' && github.ref == 'refs/heads/release')
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: Download VSIX artifact
              uses: actions/download-artifact@v4
              with:
                  name: vscode-extension-${{ github.sha }}
                  path: ./artifacts

            - name: Install publishing tools
              run: |
                  bun add -g @vscode/vsce
                  bun add -g ovsx

            - name: Get extension version
              id: version
              run: |
                  cd artifacts
                  VSIX_FILE=$(ls *.vsix | head -1)
                  # Extract version from filename or package.json
                  VERSION=$(echo $VSIX_FILE | sed -n 's/.*contractspec-\([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')
                  if [ -z "$VERSION" ]; then
                      VERSION="latest"
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "vsix-file=$VSIX_FILE" >> $GITHUB_OUTPUT

            - name: Publish to VS Code Marketplace
              working-directory: ./artifacts
              env:
                  VSCE_PAT: ${{ secrets.VSCE_PAT }}
              run: |
                  VSIX_FILE="${{ steps.version.outputs.vsix-file }}"
                  echo "ðŸš€ Publishing $VSIX_FILE to VS Code Marketplace..."
                  vsce publish --packagePath "$VSIX_FILE" --pat "$VSCE_PAT"
                  echo "âœ… Successfully published to VS Code Marketplace"

            - name: Publish to Open VSX Registry
              working-directory: ./artifacts
              env:
                  OVSX_PAT: ${{ secrets.OVSX_PAT }}
              if: env.OVSX_PAT != ''
              run: |
                  VSIX_FILE="${{ steps.version.outputs.vsix-file }}"
                  echo "ðŸš€ Publishing $VSIX_FILE to Open VSX Registry..."
                  ovsx publish "$VSIX_FILE" --pat "$OVSX_PAT"
                  echo "âœ… Successfully published to Open VSX Registry"
              continue-on-error: true

            - name: Cleanup artifacts
              if: always()
              run: rm -rf ./artifacts

    release-notes:
        name: Create Release
        needs: [build, publish]
        runs-on: ubuntu-latest
        timeout-minutes: 10
        if: |
            (github.event_name == 'workflow_dispatch' && github.event.inputs.publish == 'true') ||
            (github.event_name == 'push' && github.ref == 'refs/heads/release')
        permissions:
            contents: write
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Download VSIX artifact
              uses: actions/download-artifact@v4
              with:
                  name: vscode-extension-${{ github.sha }}
                  path: ./vsix

            - name: Get extension version and generate changelog
              id: release-info
              run: |
                  VERSION=$(jq -r .version packages/apps/vscode-contractspec/package.json)
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

                  # Generate release notes from recent commits
                  echo "## Recent Changes" > changelog-excerpt.md
                  echo "" >> changelog-excerpt.md

                  # Get recent commits related to vscode extension
                  git log --oneline --since="1 month ago" -- packages/apps/vscode-contractspec/ | head -10 | while read commit; do
                      echo "- $commit" >> changelog-excerpt.md
                  done

                  echo "" >> changelog-excerpt.md
                  echo "For full changelog, see [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/packages/apps/vscode-contractspec/CHANGELOG.md)" >> changelog-excerpt.md

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: vscode-v${{ steps.release-info.outputs.version }}
                  name: VS Code Extension v${{ steps.release-info.outputs.version }}
                  body: |
                      ## ContractSpec VS Code Extension v${{ steps.release-info.outputs.version }}

                      ### Installation

                      - **VS Code Marketplace**: Search for "ContractSpec" in VS Code Extensions
                      - **Manual**: Download the `.vsix` file below and install via `code --install-extension contractspec-${{ steps.release-info.outputs.version }}.vsix`

                      ### What's Changed

                      $(cat changelog-excerpt.md)

                      ### Verification

                      - âœ… Built and tested on Ubuntu
                      - âœ… Published to VS Code Marketplace
                      - âœ… Published to Open VSX Registry (if available)
                  files: vsix/*.vsix
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Cleanup old artifacts
              if: always()
              run: |
                  # Clean up old artifacts (keep last 5)
                  gh run list --workflow=vscode-extension.yml --json databaseId --jq '.[5:] | .[].databaseId' | xargs -I {} gh run delete {} || true
              continue-on-error: true
