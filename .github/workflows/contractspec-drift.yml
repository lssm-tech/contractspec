name: ContractSpec Drift Workflow

on:
  push:
    branches: [main]
  workflow_call:
    inputs:
      package_manager:
        description: 'Package manager to use (bun|npm|pnpm|yarn)'
        type: string
        default: bun
      working_directory:
        description: 'Working directory for running commands'
        type: string
        default: '.'
      generate_command:
        description: 'Command to regenerate artifacts'
        type: string
        required: true
      on_drift:
        description: 'Behavior when drift is detected (fail|issue|pr)'
        type: string
        default: fail
      drift_paths_allowlist:
        description: 'Comma-separated glob patterns to check for drift'
        type: string
        required: false
      token:
        description: 'GitHub token for issues/PRs'
        type: string
        default: ${{ github.token }}
    outputs:
      drift_detected:
        description: 'Whether drift was detected'
        value: ${{ jobs.contractspec.outputs.drift_detected }}

jobs:
  contractspec:
    runs-on: ubuntu-latest
    outputs:
      drift_detected: ${{ steps.result.outputs.drift_detected }}
    env:
      TURBO_TELEMETRY_DISABLED: 1
      DO_NOT_TRACK: 1
      PACKAGE_MANAGER: ${{ inputs.package_manager || 'bun' }}
      WORKING_DIRECTORY: ${{ inputs.working_directory || '.' }}
      GENERATE_COMMAND: ${{ inputs.generate_command || (github.event_name != 'workflow_call' && 'bun contractspec generate') || '' }}
      ON_DRIFT: ${{ inputs.on_drift || 'fail' }}
      DRIFT_ALLOWLIST: ${{ inputs.drift_paths_allowlist }}
      COMMENT_TOKEN: ${{ inputs.token || github.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        if: env.PACKAGE_MANAGER == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.6'

      - name: Setup Node
        if: env.PACKAGE_MANAGER != 'bun'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        shell: bash
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          case "$PACKAGE_MANAGER" in
            bun)
              if [ -f "bun.lock" ] || [ -f "bun.lockb" ]; then
                bun install --frozen-lockfile
              else
                bun install
              fi
              ;;
            npm)
              if [ -f "package-lock.json" ]; then
                npm ci
              else
                npm install
              fi
              ;;
            pnpm)
              corepack enable
              pnpm install --frozen-lockfile
              ;;
            yarn)
              corepack enable
              yarn install --frozen-lockfile
              ;;
          esac

      - name: Build local ContractSpec CLI (if present)
        if: env.PACKAGE_MANAGER == 'bun'
        shell: bash
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          if [ -f "packages/apps/cli-contractspec/package.json" ]; then
            bun run build --filter=@contractspec/app.cli-contractspec
          fi

      - name: Run generate command
        shell: bash
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          if [ -z "$GENERATE_COMMAND" ]; then
            echo "::error::generate_command is required for drift checks"
            exit 1
          fi
          bash -lc "$GENERATE_COMMAND"

      - name: Check drift
        shell: bash
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          mkdir -p .contractspec-ci
          git status --porcelain > .contractspec-ci/drift-status.txt
          python - <<'PY'
          import fnmatch
          import os
          from pathlib import Path

          allowlist_raw = os.environ.get("DRIFT_ALLOWLIST") or ""
          allowlist = [item.strip() for item in allowlist_raw.replace("\n", ",").split(",") if item.strip()]

          status_lines = Path(".contractspec-ci/drift-status.txt").read_text().splitlines()
          files = [line[3:] for line in status_lines if line.strip()]

          def is_ignored(path: str) -> bool:
            return path == ".contractspec-ci" or path.startswith(".contractspec-ci/")

          filtered = [path for path in files if path and not is_ignored(path)]
          if allowlist:
            filtered = [path for path in filtered if any(fnmatch.fnmatch(path, pattern) for pattern in allowlist)]

          Path(".contractspec-ci/drift-files.txt").write_text("\n".join(filtered))
          PY

          if [ -s ".contractspec-ci/drift-files.txt" ]; then
            echo "DRIFT_STATUS=fail" >> $GITHUB_ENV
            echo "DRIFT_DETECTED=true" >> $GITHUB_ENV
          else
            echo "DRIFT_STATUS=pass" >> $GITHUB_ENV
            echo "DRIFT_DETECTED=false" >> $GITHUB_ENV
          fi

      - name: Build report data
        shell: bash
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          report = {
            "whatChanged": {
              "summary": "Drift check completed.",
              "detailsPath": "",
            },
            "risk": {
              "status": "unknown",
              "breaking": 0,
              "nonBreaking": 0,
            },
            "validation": {
              "status": "skipped",
              "outputPath": "",
            },
            "drift": {
              "status": os.environ.get("DRIFT_STATUS", "skipped"),
              "files": Path(".contractspec-ci/drift-files.txt").read_text().splitlines() if Path(".contractspec-ci/drift-files.txt").exists() else [],
            },
            "nextSteps": [],
          }

          if report["drift"]["status"] == "fail":
            report["nextSteps"].append("Run the generate command locally and commit drift fixes.")

          Path(".contractspec-ci/report-data.json").write_text(json.dumps(report, indent=2))
          PY

      - name: Generate report
        shell: bash
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          node .github/scripts/contractspec-report.cjs --data .contractspec-ci/report-data.json --output .contractspec-ci/report.md

      - name: Create issue
        if: env.DRIFT_DETECTED == 'true' && env.ON_DRIFT == 'issue'
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.COMMENT_TOKEN }}
          script: |
            const fs = require("fs");
            const body = fs.readFileSync("${{ env.WORKING_DIRECTORY }}/.contractspec-ci/report.md", "utf8");
            const title = "ContractSpec drift detected";

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
            });

            const existing = issues.find((issue) => issue.title === title);
            if (existing) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body,
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
              });
            }

      - name: Create drift PR
        if: env.DRIFT_DETECTED == 'true' && env.ON_DRIFT == 'pr'
        shell: bash
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          GH_TOKEN: ${{ env.COMMENT_TOKEN }}
        run: |
          BRANCH="contractspec/drift-$(date +%Y%m%d%H%M%S)"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "chore(contractspec): fix drift"
          git push origin "$BRANCH"
          gh pr create \
            --title "chore(contractspec): fix drift" \
            --body-file .contractspec-ci/report.md \
            --base "${{ github.event.repository.default_branch }}" \
            --head "$BRANCH"

      - name: Finalize results
        id: result
        shell: bash
        run: |
          DRIFT_DETECTED="${DRIFT_DETECTED:-false}"
          echo "drift_detected=$DRIFT_DETECTED" >> $GITHUB_OUTPUT

          if [ "$DRIFT_DETECTED" = "true" ] && [ "$ON_DRIFT" = "fail" ]; then
            echo "::error::ContractSpec drift detected."
            exit 1
          fi
