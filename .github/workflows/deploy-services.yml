name: Deploy Services

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "packages/bundles/contractspec-studio/**"
      - "packages/apps/**"
      - ".github/workflows/deploy-services.yml"

permissions:
  contents: read

jobs:
  build:
    name: Full build monorepo
    runs-on: ubuntu-latest
    env:
      BUN_VERSION: 1.3.3
      # Increase memory for large builds
      NODE_OPTIONS: --max-old-space-size=6144
      TURBO_TELEMETRY_DISABLED: 1
      DO_NOT_TRACK: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build libraries
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
        run: bun run build

  deploy-backend:
    name: Deploy backend services
    runs-on: ubuntu-latest
    needs: build
    environment: Production
    steps:
      - name: Deploy via bastion
        uses: appleboy/ssh-action@v1
        with:
          # Target instance
          host: ${{ secrets.SCALEWAY_HOST }}
          username: ${{ secrets.SCALEWAY_USER }}
          port: 22

          # SSH key used for BOTH bastion and target
          key: ${{ secrets.SCALEWAY_SSH_PRIVATE_KEY }}

          # Bastion hop
          proxy_host: ${{ secrets.SCALEWAY_BASTION_HOST }}
          proxy_port: ${{ secrets.SCALEWAY_BASTION_PORT }}
          proxy_username: ${{ secrets.SCALEWAY_BASTION_USER }}

          script: |
            set -euo pipefail
            
            cd /srv/lssm
            
            if [ ! -d .git ]; then
              git clone git@github.com:lssm-tech/contractspec.git .
            fi
            
            git fetch origin main
            git reset --hard origin/main
            
            bun install --frozen-lockfile
            bun run build:server --concurrency 1
            # bun run db:migrate || true
            
            sudo systemctl restart lssm-api lssm-worker
            sudo systemctl status lssm-api lssm-worker --no-pager
      - name: 'Notify Vercel'
        uses: 'vercel/repository-dispatch/actions/status@v1'
        with:
          name: "Vercel - contractspec: deploy backend (services and db)"
