name: Deploy Services

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "packages/bundles/contractspec-studio/**"
      - "packages/apps/**"
      - ".github/workflows/deploy-services.yml"

permissions:
  contents: read

jobs:
  build:
    name: Full build monorepo
    runs-on: ubuntu-latest
    env:
      BUN_VERSION: 1.3.3
      # Increase memory for large builds
      NODE_OPTIONS: --max-old-space-size=6144
      TURBO_TELEMETRY_DISABLED: 1
      DO_NOT_TRACK: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build libraries
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
        run: bun run build

  deploy-backend:
    name: Deploy backend services
    runs-on: ubuntu-latest
    needs: build
    environment: Production
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SCALEWAY_SSH_PRIVATE_KEY }}
      - name: Deploy to Scaleway instance
        env:
          SCALEWAY_BASTION_USER: ${{ secrets.SCALEWAY_BASTION_USER }}
          SCALEWAY_BASTION_HOST: ${{ secrets.SCALEWAY_BASTION_HOST }}
          SCALEWAY_BASTION_PORT: ${{ secrets.SCALEWAY_BASTION_PORT }}
          SCALEWAY_HOST: ${{ secrets.SCALEWAY_HOST }}
          SCALEWAY_USER: ${{ secrets.SCALEWAY_USER }}
        run: |
          ssh  -o StrictHostKeyChecking=no \
            -J "${BASTION_USER}@${BASTION_HOST}:${BASTION_PORT}" \
            "${TARGET_USER}@${TARGET_HOST}" << 'EOF'
            set -euo pipefail

            cd /srv/lssm

            # first deploy: clone; later: pull
            if [ ! -d .git ]; then
              git clone git@github.com:lssm-tech/contractspec.git .
            fi

            git fetch origin main
            git reset --hard origin/main

            bun install --frozen-lockfile
            bun run build:server
            # bun run db:migrate || true

            sudo systemctl restart lssm-api lssm-worker
            sudo systemctl status lssm-api lssm-worker --no-pager
          EOF
      - name: 'notify vercel'
        uses: 'vercel/repository-dispatch/actions/status@v1'
        with:
          name: "Vercel - contractspec: deploy backend (services and db)"
