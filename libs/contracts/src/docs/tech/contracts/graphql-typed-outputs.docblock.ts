import type { DocBlock } from '@contractspec/lib.contracts/docs';
import { registerDocBlocks } from '../../registry';

export const tech_contracts_graphql_typed_outputs_DocBlocks: DocBlock[] = [
  {
    id: 'docs.tech.contracts.graphql-typed-outputs',
    title: 'GraphQL Typed Outputs for Contracts',
    summary:
      'Improved `@contractspec/lib.contracts` to automatically generate proper GraphQL object types from `SchemaModel` outputs instead of defaulting to `JSON` scalar types.',
    kind: 'reference',
    visibility: 'public',
    route: '/docs/tech/contracts/graphql-typed-outputs',
    tags: ['tech', 'contracts', 'graphql-typed-outputs'],
    body: "# GraphQL Typed Outputs for Contracts\n\n## Overview\n\nImproved `@contractspec/lib.contracts` to automatically generate proper GraphQL object types from `SchemaModel` outputs instead of defaulting to `JSON` scalar types.\n\n## Problem\n\nPreviously, when GraphQL operations were defined using contracts with `SchemaModel` outputs, the GraphQL schema would default to returning `JSON` scalar types. This meant:\n\n- GraphQL clients couldn't query specific fields\n- No type safety for operation outputs\n- Codegen would fail with \"must have a selection of subfields\" errors\n\n## Solution\n\n### 1. Auto-Type Registration in `graphql-pothos.ts`\n\n**File**: `packages/lssm/libs/contracts/src/server/graphql-pothos.ts`\n\n**Changes**:\n\n- Scan all contract specs and collect their `SchemaModel` outputs\n- Automatically register GraphQL object types for each `SchemaModel`\n- Map field types from SchemaModel to proper GraphQL scalar types\n- Update `resolveGraphQLTypeName` to check for `SchemaModel` names before defaulting to `JSON`\n\n**Key Code**:\n\n```typescript\n// Build a map of output types we need to register\nconst outputTypeCache = new Map<string, AnySchemaModel>();\nfor (const spec of reg.listSpecs()) {\n  const out = spec.io.output as AnySchemaModel | ResourceRefDescriptor<boolean>;\n  if (out && 'getZod' in out && typeof out.getZod === 'function') {\n    const model = out as AnySchemaModel;\n    const typeName = model.config?.name ?? 'UnknownOutput';\n    if (!outputTypeCache.has(typeName)) {\n      outputTypeCache.set(typeName, model);\n    }\n  }\n}\n\n// Register all output types as GraphQL object types\nfor (const [typeName, model] of outputTypeCache.entries()) {\n  builder.objectType(typeName, {\n    fields: (t) => {\n      // Map each field from SchemaModel to GraphQL field\n      // ...\n    },\n  });\n}\n```\n\n### 2. Fix Contract Definitions\n\n**File**: `packages/hcircle/libs/contracts-coliving/src/interactions/onboarding/org/contracts.ts`\n\n**Changes**:\n\n- Changed `GetOrgOnboardingDraftSpec` from `defineCommand` to `defineQuery` (read-only operation)\n- Added `defineQuery` import\n\n**Before**:\n\n```typescript\nexport const GetOrgOnboardingDraftSpec = defineCommand({\n  // ...\n});\n```\n\n**After**:\n\n```typescript\nexport const GetOrgOnboardingDraftSpec = defineQuery({\n  // ...\n});\n```\n\n### 3. Update All GraphQL Queries\n\nUpdated all GraphQL operation calls to select proper subfields based on the output type:\n\n#### Output Types and Their Fields\n\n1. **`CreateOrgOutput`**:\n   - `organizationId: ID!`\n   - `orgType: String!`\n\n2. **`CompleteUserOnboardingOutput`**:\n   - `success: Boolean!`\n   - `userId: ID!`\n\n3. **`CompleteOrgOnboardingOutput`**:\n   - `success: Boolean!`\n   - `organizationId: ID!`\n   - `orgType: String!`\n\n4. **`OnboardingDraft`** (from resource_ref):\n   - `id: ID!`\n   - `organizationId: ID!`\n   - `data: JSON!`\n   - `createdAt: DateTime!`\n   - `updatedAt: DateTime!`\n\n5. **`GetOnboardingDraftOutput`**:\n   - `id: ID`\n   - `organizationId: ID`\n   - `data: JSON`\n   - `createdAt: DateTime`\n   - `updatedAt: DateTime`\n\n6. **`DeleteOnboardingDraftOutput`**:\n   - `ok: Boolean!` _(note: not `success`)_\n\n#### Files Updated\n\n1. `/packages/hcircle/apps/mobile-coliving/src/app/onboarding-org-select.tsx`\n2. `/packages/hcircle/apps/mobile-coliving/src/app/onboarding-org.tsx`\n3. `/packages/hcircle/apps/mobile-coliving/src/app/onboarding-user.tsx`\n4. `/packages/hcircle/apps/web-coliving/src/app/onboarding/user/page.tsx`\n5. `/packages/hcircle/apps/web-coliving/src/components/onboarding/OnboardingFlow.tsx`\n6. `/packages/hcircle/apps/web-coliving/src/components/onboarding/OrgSelectionFlow.tsx`\n\n**Example Before**:\n\n```graphql\nmutation CreateOrg($orgType: String!, $name: String!, $slug: String!) {\n  createOrganization(input: { orgType: $orgType, name: $name, slug: $slug })\n}\n```\n\n**Example After**:\n\n```graphql\nmutation CreateOrg($orgType: String!, $name: String!, $slug: String!) {\n  createOrganization(input: { orgType: $orgType, name: $name, slug: $slug }) {\n    organizationId\n    orgType\n  }\n}\n```\n\n## Benefits\n\n1. **Type Safety**: Full type safety for GraphQL operation outputs\n2. **Auto-Generated Types**: No need to manually specify `returns` in contract transport config\n3. **Better DX**: GraphQL clients can now query specific fields and benefit from autocomplete\n4. **Consistency**: All `SchemaModel` outputs are automatically typed in GraphQL\n5. **Backward Compatible**: Operations with explicit `returns` config still work as before\n\n## Testing\n\nAll GraphQL codegen now passes:\n\n```bash\ncd packages/hcircle/libs/gql-client-coliving\nbun graphql-codegen --config codegen.ts  # \u2705 Success\n```\n\n## Migration Guide for Other Verticals\n\nTo apply this to other verticals (e.g., Artisanos, Strit):\n\n1. **No code changes needed** - the improved `graphql-pothos.ts` automatically handles all `SchemaModel` outputs\n2. **Update GraphQL queries** - Add field selections to queries that previously returned `JSON`\n3. **Fix query/command mismatches** - Ensure read-only operations use `defineQuery` instead of `defineCommand`\n\n## Future Improvements\n\n1. Add support for nested `SchemaModel` references (currently only supports scalar fields)\n2. Add support for array fields of SchemaModels\n3. Consider auto-generating field selections based on the output type to reduce boilerplate\n\n## Related Documentation\n\n- [Contracts README](../../packages/lssm/libs/contracts/README.md)\n- [Onboarding System](./hcircle/IMPLEMENTATION_COMPLETE.md)\n- [GraphQL Architecture](./graphql/architecture.md)\n",
  },
];
registerDocBlocks(tech_contracts_graphql_typed_outputs_DocBlocks);
